# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # BOX base
  config.vm.box = "generic/ubuntu2204"

  # Configuración del proveedor (libvirt)
  config.vm.provider :libvirt do |libvirt|
    libvirt.driver = "kvm"
  end

  # Configuración SSH: clave compartida entre nodos
  config.ssh.insert_key = false

  # Red privada común entre todos los nodos
  NETWORK_NAME = "red-interna"
  NETWORK_CIDR = "10.20.30."

  # --- Nodo MASTER ---
  config.vm.define "master" do |master|
    master.vm.hostname = "master"
    master.vm.network :private_network,
      libvirt__network_name: NETWORK_NAME,
      libvirt__dhcp_enabled: true,
      ip: "#{NETWORK_CIDR}10",
      libvirt__forward_mode: "none"

    master.vm.provider :libvirt do |libvirt|
      libvirt.memory = 4096
      libvirt.cpus = 2
    end

    # Instala Python3 para Ansible
    master.vm.provision "shell", inline: <<-SHELL
      apt-get update -y
      apt-get install -y python3 python3-apt
    SHELL
  end

  # --- Worker 1 ---
  config.vm.define "worker1" do |worker1|
    worker1.vm.hostname = "worker1"
    worker1.vm.network :private_network,
      libvirt__network_name: NETWORK_NAME,
      libvirt__dhcp_enabled: true,
      ip: "#{NETWORK_CIDR}11",
      libvirt__forward_mode: "none"

    worker1.vm.provider :libvirt do |libvirt|
      libvirt.memory = 2048
      libvirt.cpus = 2
    end

    worker1.vm.provision "shell", inline: <<-SHELL
      apt-get update -y
      apt-get install -y python3 python3-apt
    SHELL
  end

  # --- Worker 2 ---
  config.vm.define "worker2" do |worker2|
    worker2.vm.hostname = "worker2"
    worker2.vm.network :private_network,
      libvirt__network_name: NETWORK_NAME,
      libvirt__dhcp_enabled: true,
      ip: "#{NETWORK_CIDR}12",
      libvirt__forward_mode: "none"

    worker2.vm.provider :libvirt do |libvirt|
      libvirt.memory = 2048
      libvirt.cpus = 2
    end

    worker2.vm.provision "shell", inline: <<-SHELL
      apt-get update -y
      apt-get install -y python3 python3-apt
    SHELL
  end
end

